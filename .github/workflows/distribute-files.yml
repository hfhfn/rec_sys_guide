name: Auto Distribute Files

# è§¦å‘æ¡ä»¶ï¼š
# 1. æ‰‹åŠ¨è§¦å‘
# 2. å‘ main åˆ†æ”¯æ¨é€æ—¶
# 3. å®šæœŸæ¯å‘¨æ‰§è¡Œ

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  push:
    branches:
      - main
    paths:
      - 'æ¨è**/**'
      - 'scripts/distribute_files.py'
  schedule:
    - cron: '0 0 * * 0'  # æ¯å‘¨æ—¥ 0:00 UTC è¿è¡Œ

jobs:
  distribute:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: ğŸ è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install huggingface_hub

      - name: ğŸš€ è¿è¡Œåˆ†å‘è„šæœ¬
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USERNAME: ${{ secrets.HF_USERNAME }}
        run: |
          cd ${{ github.workspace }}
          python scripts/distribute_files.py

      - name: ğŸ“ ç”Ÿæˆä¸‹è½½åˆ—è¡¨
        run: |
          python -c "
          import json
          from pathlib import Path

          manifest_path = Path('data/file_manifest.json')
          if manifest_path.exists():
              with open(manifest_path, 'r', encoding='utf-8') as f:
                  manifest = json.load(f)
              print(f'âœ… æ–‡ä»¶æ¸…å•åŒ…å« {len(manifest[\"files\"])} ä¸ªæ–‡ä»¶')
          "

      - name: ğŸ“¤ æäº¤æ–‡ä»¶æ¸…å•
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "ğŸ¤– Auto: Update file manifest"
          file_pattern: 'data/file_manifest.json .gitignore'
          skip_dirty_check: true

      - name: âœ… åˆ†å‘å®Œæˆ
        run: |
          echo "âœ… æ–‡ä»¶å·²è‡ªåŠ¨åˆ†å‘:"
          echo "  ğŸ“¦ å¤§æ–‡ä»¶ â†’ HuggingFace Datasets"
          echo "  ğŸ“„ å°æ–‡ä»¶ â†’ GitHub Repository"
          echo "  ğŸŒ ç´¢å¼•å·²æ›´æ–° â†’ data/file_manifest.json"
