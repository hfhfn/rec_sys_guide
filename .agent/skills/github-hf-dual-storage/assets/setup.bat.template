@echo off
REM Dual-Storage Setup Script v3.0 (Windows)
REM Environment check + dependency installation + first distribution
setlocal enabledelayedexpansion
chcp 65001 >nul

echo.
echo ============================================
echo   GitHub + HuggingFace 自动分发系统 v3.0
echo ============================================
echo.

REM --- 1. Python 检查 ---
echo [1/5] 正在检查 Python...
python --version >nul 2>&1
if errorlevel 1 (
    echo [ERROR] 未找到 Python，请先安装 Python 3.8+
    pause
    exit /b 1
)

REM --- 2. 安装依赖 ---
echo.
echo [2/5] 正在安装 huggingface_hub...
pip install -q "huggingface_hub>=0.17.0"
echo   OK: 依赖安装完成

REM --- 3. HuggingFace 认证 ---
echo.
echo [3/5] HuggingFace 身份认证
if defined HF_TOKEN (
    echo   检测到 HF_TOKEN 环境变量，跳转。
    goto :skip_hf_auth
)
python -c "from huggingface_hub import HfApi; HfApi().whoami()" >nul 2>&1
if not errorlevel 1 (
    echo   已通过 huggingface-cli 登录。
    goto :skip_hf_auth
)

echo   未检测到 HF 认证信息。
echo   a) 立即运行 huggingface-cli login 登录
echo   b) 跳过上传（仅生成本地清单）
set /p hf_choice="  请选择 [a/b] (默认 b): "
if /i "%hf_choice%"=="a" (
    huggingface-cli login
) else (
    echo   已跳过认证。
)

:skip_hf_auth

REM --- 4. 运行分发逻辑 ---
echo.
echo [4/5] 正在执行文件分发与同步...
echo   说明：此操作将上传大文件到 HF，并清理远程冗余文件。
cd /d "%~dp0.."
python scripts\distribute_files.py

REM --- 5. 提交并同步到 GitHub ---
echo.
echo [5/5] 正在提交配置到 Git...
git add .
git diff --cached --quiet
if errorlevel 1 (
    echo.
    set /p commit_msg="输入提交信息 (直接回车默认: Initial dual-storage setup): "
    if "!commit_msg!"=="" set commit_msg=Initial dual-storage setup
    git commit -m "!commit_msg!"
    echo.
    echo 正在推送到 GitHub...
    git push origin main
    if errorlevel 1 (
        echo [ERROR] 推送至 GitHub 失败，请检查网络或权限。
    ) else (
        echo   OK: 全部分发与同步完成！
    )
) else (
    echo   无需提交，配置文件已是最新。
)

echo.
echo ============================================
echo   设置完成！您的双端存储系统已就绪。
echo ============================================
echo.
pause
